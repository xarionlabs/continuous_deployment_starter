name: staging-release
on:
  workflow_run:
    workflows: ["build"]
    branches: [main]
    types: 
      - completed

jobs:
  release:
    runs-on: ubuntu-latest
    environment: staging
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.HOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            cd ~/runtime/continuous_deployment_starter
            git checkout releases
            git pull origin releases
            export PATH="$PATH:$(pwd)/.github/workflows/scripts"
            echo $PATH
            source services/version.env
            generate-env-from-gh.sh
            source .env
            check-service-envs.sh
            # generate application deployment configs
            # currently static, app_1, nginx
            cd services/
            cd app_1/
            cat docker-compose.yml | { eval "echo \"$(sed 's/"/\\"/g')\""; } | podman run -i --rm -v ~/.config/containers/systemd:/app/systemd ghcr.io/containers/podlet --file /app/systemd --overwrite compose -
            cd ../postgres/
            cat docker-compose.yml | { eval "echo \"$(sed 's/"/\\"/g')\""; } | podman run -i --rm -v ~/.config/containers/systemd:/app/systemd ghcr.io/containers/podlet --file /app/systemd --overwrite compose -
            cd ../nginx-proxy/
            cat docker-compose.yml | { eval "echo \"$(sed 's/"/\\"/g')\""; } | podman run -i --rm -v ~/.config/containers/systemd:/app/systemd ghcr.io/containers/podlet --file /app/systemd --overwrite compose -
            systemctl --user daemon-reload
            systemctl --user restart app_1
            systemctl --user restart postgres
            systemctl --user restart nginx_proxy
